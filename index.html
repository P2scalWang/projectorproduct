<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh; padding:20px; color:#1a1a2e;
    }
    .container{ max-width:720px; margin:0 auto; }
    .header{ text-align:center; margin-bottom:40px; animation:fadeInDown 0.6s ease; }
    .header h1{ color:#fff; font-size:2.5rem; font-weight:700; margin-bottom:10px; text-shadow:0 2px 20px rgba(0,0,0,0.1); }
    .header p{ color:rgba(255,255,255,0.9); font-size:1.1rem; }
    .form-card{ background:#fff; border-radius:24px; padding:40px; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:fadeInUp 0.6s ease; }
    .form-group{ margin-bottom:28px; }
    label{ display:block; font-weight:600; margin-bottom:10px; color:#2d3748; font-size:0.95rem; }
    .required{ color:#e53e3e; margin-left:4px; }
    input[type="text"], input[type="tel"], input[type="date"], select{
      width:100%; padding:14px 18px; border:2px solid #e2e8f0; border-radius:12px; font-size:1rem; transition:.3s; background:#f7fafc;
    }
    input[type="text"]:focus, input[type="tel"]:focus, input[type="date"]:focus, select:focus{
      outline:none; border-color:#667eea; background:#fff; box-shadow:0 0 0 4px rgba(102,126,234,.1);
    }
    select{ cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; background-size:20px; padding-right:45px; }
    .file-upload-wrapper{ position:relative; }
    .file-upload-label{ display:flex; align-items:center; justify-content:center; padding:24px; border:3px dashed #cbd5e0; border-radius:12px; cursor:pointer; transition:.3s; background:#f7fafc; min-height:120px; }
    .file-upload-label:hover{ border-color:#667eea; background:#edf2f7; }
    .file-upload-label svg{ margin-right:12px; }
    input[type="file"]{ display:none; }
    .file-preview{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:12px; margin-top:12px; }
    .preview-item{ position:relative; border-radius:8px; overflow:hidden; aspect-ratio:1; border:2px solid #e2e8f0; }
    .preview-item img{ width:100%; height:100%; object-fit:cover; }
    .preview-item button{ position:absolute; top:4px; right:4px; background:rgba(0,0,0,0.7); color:#fff; border:none; border-radius:50%; width:28px; height:28px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:.2s; }
    .preview-item button:hover{ background:#e53e3e; transform:scale(1.1); }
    .submit-btn{ width:100%; padding:16px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:12px; font-size:1.1rem; font-weight:600; cursor:pointer; transition:.3s; box-shadow:0 4px 15px rgba(102,126,234,0.4); }
    .submit-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,0.5); }
    .submit-btn:active{ transform:translateY(0); }
    .submit-btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:1000; animation:fadeIn .3s ease; }
    .modal-content{ position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border-radius:20px; padding:40px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; animation:slideUp .4s ease; }
    .modal-header{ display:flex; align-items:center; margin-bottom:24px; padding-bottom:20px; border-bottom:2px solid #e2e8f0; }
    .modal-header svg{ margin-right:12px; flex-shrink:0; }
    .modal-header h2{ color:#2d3748; font-size:1.5rem; }
    .info-section{ background:#f7fafc; padding:20px; border-radius:12px; margin-bottom:20px; }
    .info-section h3{ color:#667eea; margin-bottom:12px; font-size:1.1rem; }
    .info-section ul{ list-style:none; padding-left:0; }
    .info-section li{ padding:8px 0; padding-left:24px; position:relative; line-height:1.6; }
    .info-section li:before{ content:"‚úì"; position:absolute; left:0; color:#667eea; font-weight:bold; }
    .data-review{ margin-top:24px; }
    .data-item{ display:flex; padding:12px 0; border-bottom:1px solid #e2e8f0; }
    .data-label{ font-weight:600; color:#4a5568; min-width:150px; }
    .data-value{ color:#2d3748; flex:1; }
    .modal-actions{ display:flex; gap:12px; margin-top:28px; }
    .btn{ flex:1; padding:14px; border-radius:10px; font-size:1rem; font-weight:600; cursor:pointer; transition:.3s; border:2px solid transparent; }
    .btn-cancel{ background:#edf2f7; color:#4a5568; }
    .btn-cancel:hover{ background:#e2e8f0; }
    .btn-confirm{ background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; box-shadow:0 4px 15px rgba(102,126,234,0.4); }
    .btn-confirm:hover{ transform:translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,0.5); }
    .btn-confirm:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .success-modal{ text-align:center; }
    .success-icon{ width:80px; height:80px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 24px; }
    .loading{ display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin .8s linear infinite; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes fadeInDown{ from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)} }
    @keyframes fadeInUp{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    @keyframes slideUp{ from{opacity:0; transform:translate(-50%, -45%)} to{opacity:1; transform:translate(-50%, -50%)} }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    @media (max-width:640px){
      .header h1{ font-size:1.8rem; }
      .form-card{ padding:24px; }
      .modal-content{ padding:24px; }
      .data-item{ flex-direction:column; }
      .data-label{ margin-bottom:4px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì¶ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
    </div>

    <div class="form-card">
      <!-- NOTE: we keep JS-driven submit to allow the confirm modal; enctype is for semantics -->
      <form id="warrantyForm" enctype="multipart/form-data">
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•<span class="required">*</span></label>
          <input type="text" id="fullName" name="fullName" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required />
        </div>

        <div class="form-group">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå<span class="required">*</span></label>
          <input type="tel" id="phone" name="phone" placeholder="08X-XXX-XXXX" required />
        </div>

        <div class="form-group">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
          <input type="date" id="purchaseDate" name="purchaseDate" />
        </div>

        <div class="form-group">
          <label>‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<span class="required">*</span></label>
          <select id="productModel" name="productModel" required>
            <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</option>
          </select>
        </div>

        <div class="form-group">
          <label>Serial Number<span class="required">*</span></label>
          <input type="text" id="serialNumber" name="serialNumber" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Serial Number" required />
        </div>

        <div class="form-group">
          <label>‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ Serial Number<span class="required">*</span></label>
          <div class="file-upload-wrapper">
            <label for="serialPhotos" class="file-upload-label">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
              <div>
                <div style="font-weight:600;color:#667eea;margin-bottom:4px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</div>
                <div style="font-size:.85rem;color:#718096;">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</div>
              </div>
            </label>
            <!-- IMPORTANT: add name so FormData(form) includes it automatically -->
            <input type="file" id="serialPhotos" name="serialPhotos" accept="image/*" multiple capture="environment" />
            <div id="photoPreview" class="file-preview"></div>
          </div>
        </div>

        <div class="form-group">
          <label>‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡πÑ‡∏´‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input type="text" id="dealer" name="dealer" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤" />
        </div>

        <button type="submit" class="submit-btn">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
      </form>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
      </div>

      <div class="info-section">
        <h3>üìã ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô</h3>
        <ul>
          <li>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πà‡∏≠‡∏á‡∏£‡∏≠‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á</li>
          <li>Serial Number ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</li>
          <li>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
          <li>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏°</li>
          <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</li>
        </ul>
      </div>

      <div class="data-review">
        <h3 style="color:#2d3748;margin-bottom:16px;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
        <div id="reviewData"></div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-cancel" onclick="closeModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button type="button" class="btn btn-confirm" onclick="confirmSubmit()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content success-modal">
      <div class="success-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <h2 style="color:#2d3748;margin-bottom:12px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
      <p style="color:#718096;margin-bottom:28px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
      <button type="button" class="btn btn-confirm" onclick="location.reload()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
    </div>
  </div>

  <script>
    // ============ CONFIG SECTION ============
    const CONFIG = {
      SHEETS_URL: 'https://docs.google.com/spreadsheets/d/1-5j1UN3xuTJB1be1IdAjPRvMA90yngtlQ-ylSiv2rEY/export?format=csv&gid=332563834',
      WEBHOOK_URL: 'https://n8n-p2sw2ng.p2scalw2ng.xyz/webhook/ProOutput'
    };
    // ========================================

    let selectedFiles = [];
    let reviewCache = {};

    // Load product models (Column A from CSV)
    async function loadProducts(){
      const select = document.getElementById('productModel');
      try{
        select.innerHTML = '<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
        const res = await fetch(CONFIG.SHEETS_URL);
        const csv = await res.text();
        const lines = csv.split('\n');
        const products = [];
        for(let i=1;i<lines.length;i++){
          const line = lines[i].trim();
          if(!line) continue;
          const cols = line.split(',');
          const model = (cols[0]||'').replace(/^"(.+)"$/, '$1').trim();
          if(model) products.push(model);
        }
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        products.forEach(m=>{
          const opt = document.createElement('option');
          opt.value = m; opt.textContent = m; select.appendChild(opt);
        });
      }catch(err){
        console.error(err);
        select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</option>';
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Google Sheets URL');
      }
    }
    window.addEventListener('load', loadProducts);

    // File handling
    const fileInput = document.getElementById('serialPhotos');
    fileInput.addEventListener('change', (e)=>{
      const files = Array.from(e.target.files);
      // Optional: limit number or size here if needed
      selectedFiles = [...selectedFiles, ...files];
      updatePhotoPreview();
      // clear the input so the same file can be re-selected later
      fileInput.value = '';
    });

    function updatePhotoPreview(){
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      selectedFiles.forEach((file, idx)=>{
        const url = URL.createObjectURL(file);
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <img src="${url}" alt="Preview" />
          <button type="button" aria-label="remove" onclick="removePhoto(${idx})">&times;</button>
        `;
        preview.appendChild(div);
      });
    }
    function removePhoto(index){
      selectedFiles.splice(index,1); updatePhotoPreview();
    }

    // Intercept submit to open confirm modal
    document.getElementById('warrantyForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      if(selectedFiles.length === 0){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ Serial Number ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ');
        return;
      }
      reviewCache = {
        fullName: document.getElementById('fullName').value,
        phone: document.getElementById('phone').value,
        purchaseDate: document.getElementById('purchaseDate').value || '-',
        productModel: document.getElementById('productModel').value,
        serialNumber: document.getElementById('serialNumber').value,
        dealer: document.getElementById('dealer').value || '-',
        photoCount: selectedFiles.length,
        submittedAt: new Date().toLocaleString('th-TH')
      };
      const reviewHtml = `
        <div class="data-item"><div class="data-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</div><div class="data-value">${reviewCache.fullName}</div></div>
        <div class="data-item"><div class="data-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</div><div class="data-value">${reviewCache.phone}</div></div>
        <div class="data-item"><div class="data-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</div><div class="data-value">${reviewCache.purchaseDate}</div></div>
        <div class="data-item"><div class="data-label">‡∏£‡∏∏‡πà‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</div><div class="data-value">${reviewCache.productModel}</div></div>
        <div class="data-item"><div class="data-label">Serial Number:</div><div class="data-value">${reviewCache.serialNumber}</div></div>
        <div class="data-item"><div class="data-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢:</div><div class="data-value">${reviewCache.photoCount} ‡∏£‡∏π‡∏õ</div></div>
        <div class="data-item"><div class="data-label">‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢:</div><div class="data-value">${reviewCache.dealer}</div></div>
      `;
      document.getElementById('reviewData').innerHTML = reviewHtml;
      document.getElementById('confirmModal').style.display = 'block';
    });

    function closeModal(){ document.getElementById('confirmModal').style.display = 'none'; }

    async function confirmSubmit(){
      const btn = document.querySelector('.btn-confirm');
      const orig = btn.innerHTML; btn.innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'; btn.disabled = true;
      try{
        // IMPORTANT: Send as multipart/form-data with FormData + binary files
        // Do NOT set Content-Type header manually; browser will set the boundary.
        const fd = new FormData();
        // Append text fields
        fd.append('fullName', reviewCache.fullName);
        fd.append('phone', reviewCache.phone);
        fd.append('purchaseDate', reviewCache.purchaseDate);
        fd.append('productModel', reviewCache.productModel);
        fd.append('serialNumber', reviewCache.serialNumber);
        fd.append('dealer', reviewCache.dealer);
        fd.append('submittedAt', reviewCache.submittedAt);
        fd.append('photoCount', String(reviewCache.photoCount));

        // Append files (same field name for multiple files)
        const serialSafe = (reviewCache.serialNumber || 'SN').replace(/[^a-zA-Z0-9_-]+/g, '-');
        selectedFiles.forEach((file, i)=>{
          const ext = (file.name.split('.').pop() || '').toLowerCase();
          const niceName = `${serialSafe}_${Date.now()}_${i}.${ext || 'jpg'}`;
          fd.append('serialPhotos', file, niceName);
        });

        const res = await fetch(CONFIG.WEBHOOK_URL, { method:'POST', body: fd });
        if(!res.ok) throw new Error('Failed to send data');

        document.getElementById('confirmModal').style.display = 'none';
        document.getElementById('successModal').style.display = 'block';
      }catch(err){
        console.error(err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö WEBHOOK_URL ‡πÉ‡∏ô CONFIG');
        btn.innerHTML = orig; btn.disabled = false;
      }
    }

    // Close modals on backdrop click
    window.addEventListener('click', (e)=>{
      const confirmModal = document.getElementById('confirmModal');
      const successModal = document.getElementById('successModal');
      if(e.target === confirmModal) closeModal();
      if(e.target === successModal) successModal.style.display = 'none';
    });
  </script>
</body>
</html>
